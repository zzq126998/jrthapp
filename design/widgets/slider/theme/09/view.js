define(function(require){function t(t,a){var n=t.attr("data-width"),i=parseInt(t.attr("data-height"),10);"100%"==n&&(n=t.innerWidth());var e='<ul class="roundabout"></ul>',o=$(e).css({width:n,height:i}).appendTo(t);$.each(a,function(t,a){var n='<li><a href="'+(a.url||"javascript:void(0)")+'"></a></li>',i=$(n);o.append(i)}),o.roundabout({autoplay:!0,autoplayDuration:5e3,autoplayPauseOnHover:!0});var r=o.find("li");$.each(a,function(t,a){var n=$('<img src="'+a.src+'" alt="'+a.alt+'" />').appendTo(r.eq(t).find("a"));n.on("load",function(){var t=$(this).parents(".roundabout-moveable-item").height();this.setAttribute("_width",this.width),this.setAttribute("_height",this.height),this.parentNode.style.lineHeight=t+"px"})})}function a(a,n,i){if(a!==!0){var n=a.find(".roundabout").parent(),i=[];$.each(n.find(".roundabout li"),function(t,a){var n={};n.src=$(a).find("img").attr("src"),n.alt=$(a).find("img").attr("alt"),n.url=$(a).find("a").attr("href"),i.push(n)}),n.empty()}t(n,i)}var n,i,e,$=require("jquery");return $.extend({roundaboutShapes:{def:"lazySusan",lazySusan:function(t,a,n){return{x:Math.sin(t+a),y:Math.sin(t+3*Math.PI/2+a)/8*n,z:(Math.cos(t+a)+1)/2,scale:Math.sin(t+Math.PI/2+a)/2+.5}}}}),n={bearing:0,tilt:0,minZ:100,maxZ:280,minOpacity:.4,maxOpacity:1,minScale:.4,maxScale:1,duration:600,btnNext:null,btnNextCallback:function(){},btnPrev:null,btnPrevCallback:function(){},btnToggleAutoplay:null,btnStartAutoplay:null,btnStopAutoplay:null,easing:"swing",clickToFocus:!0,clickToFocusCallback:function(){},focusBearing:0,shape:"lazySusan",debug:!1,childSelector:"li",startingChild:null,reflect:!1,floatComparisonThreshold:.001,autoplay:!1,autoplayDuration:1e3,autoplayPauseOnHover:!1,autoplayCallback:function(){},autoplayInitialDelay:0,enableDrag:!1,dropDuration:600,dropEasing:"swing",dropAnimateTo:"nearest",dropCallback:function(){},dragAxis:"x",dragFactor:4,triggerFocusEvents:!0,triggerBlurEvents:!0,responsive:!1},i={autoplayInterval:null,autoplayIsRunning:!1,autoplayStartTimeout:null,animating:!1,childInFocus:-1,touchMoveStartPosition:null,stopAnimation:!1,lastAnimationStep:!1},e={init:function(t,a,o){{var r;(new Date).getTime()}return t="object"==typeof t?t:{},a=$.isFunction(a)?a:function(){},a=$.isFunction(t)?t:a,r=$.extend({},n,t,i),this.each(function(){var t=$(this),n=t.children(r.childSelector).length,i=360/n,u=r.startingChild&&r.startingChild>n-1?n-1:r.startingChild,l=null===r.startingChild?r.bearing:360-u*i,s="static"!==t.css("position")?t.css("position"):"relative";t.css({padding:0,position:s}).addClass("roundabout-holder").data("roundabout",$.extend({},r,{startingChild:u,bearing:l,oppositeOfFocusBearing:e.normalize.apply(null,[r.focusBearing-180]),dragBearing:l,period:i})),o?t.unbind(".roundabout").children(r.childSelector).unbind(".roundabout"):r.responsive&&$(window).bind("resize",function(){e.stopAutoplay.apply(t),e.relayoutChildren.apply(t)}),r.clickToFocus&&t.children(r.childSelector).each(function(a){$(this).bind("click.roundabout",function(){var n=e.getPlacement.apply(t,[a]);return e.isInFocus.apply(t,[n])?void 0:(e.stopAnimation.apply($(this)),t.data("roundabout").animating||e.animateBearingToFocus.apply(t,[n,t.data("roundabout").clickToFocusCallback]),!1)})}),r.btnNext&&$(r.btnNext).bind("click.roundabout",function(){return t.data("roundabout").animating||e.animateToNextChild.apply(t,[t.data("roundabout").btnNextCallback]),!1}),r.btnPrev&&$(r.btnPrev).bind("click.roundabout",function(){return e.animateToPreviousChild.apply(t,[t.data("roundabout").btnPrevCallback]),!1}),r.btnToggleAutoplay&&$(r.btnToggleAutoplay).bind("click.roundabout",function(){return e.toggleAutoplay.apply(t),!1}),r.btnStartAutoplay&&$(r.btnStartAutoplay).bind("click.roundabout",function(){return e.startAutoplay.apply(t),!1}),r.btnStopAutoplay&&$(r.btnStopAutoplay).bind("click.roundabout",function(){return e.stopAutoplay.apply(t),!1}),r.autoplayPauseOnHover&&t.bind("mouseenter.roundabout.autoplay",function(){e.stopAutoplay.apply(t,[!0])}).bind("mouseleave.roundabout.autoplay",function(){e.startAutoplay.apply(t)}),r.enableDrag&&($.isFunction(t.drag)?$.isFunction(t.drop)?t.drag(function(a,n){var i=t.data("roundabout"),o="x"===i.dragAxis.toLowerCase()?"deltaX":"deltaY";e.stopAnimation.apply(t),e.setBearing.apply(t,[i.dragBearing+n[o]/i.dragFactor])}).drop(function(){var a=t.data("roundabout"),n=e.getAnimateToMethod(a.dropAnimateTo);e.allowAnimation.apply(t),e[n].apply(t,[a.dropDuration,a.dropEasing,a.dropCallback]),a.dragBearing=a.period*e.getNearestChild.apply(t)}):r.debug&&alert("You do not have the drop plugin loaded."):r.debug&&alert("You do not have the drag plugin loaded."),t.each(function(){var t=$(this).get(0),a=$(this).data("roundabout"),n="x"===a.dragAxis.toLowerCase()?"pageX":"pageY",i=e.getAnimateToMethod(a.dropAnimateTo);t.addEventListener&&(t.addEventListener("touchstart",function(t){a.touchMoveStartPosition=t.touches[0][n]},!1),t.addEventListener("touchmove",function(t){var i=(t.touches[0][n]-a.touchMoveStartPosition)/a.dragFactor;t.preventDefault(),e.stopAnimation.apply($(this)),e.setBearing.apply($(this),[a.dragBearing+i])},!1),t.addEventListener("touchend",function(t){t.preventDefault(),e.allowAnimation.apply($(this)),i=e.getAnimateToMethod(a.dropAnimateTo),e[i].apply($(this),[a.dropDuration,a.dropEasing,a.dropCallback]),a.dragBearing=a.period*e.getNearestChild.apply($(this))},!1))})),e.initChildren.apply(t,[a,o])})},initChildren:function(t,a){var n=$(this),i=n.data("roundabout");return t=t||function(){},n.children(i.childSelector).each(function(t){var i,o,r,u=e.getPlacement.apply(n,[t]);a&&$(this).data("roundabout")&&(i=$(this).data("roundabout").startWidth,o=$(this).data("roundabout").startHeight,r=$(this).data("roundabout").startFontSize),$(this).addClass("roundabout-moveable-item").css("position","absolute"),$(this).data("roundabout",{startWidth:i||$(this).width(),startHeight:o||$(this).height(),startFontSize:r||parseInt($(this).css("font-size"),10),degrees:u,backDegrees:e.normalize.apply(null,[u-180]),childNumber:t,currentScale:1,parent:n})}),e.updateChildren.apply(n),i.autoplay&&(i.autoplayStartTimeout=setTimeout(function(){e.startAutoplay.apply(n)},i.autoplayInitialDelay)),n.trigger("ready"),t.apply(n),n},updateChildren:function(){return this.each(function(){var t=$(this),a=t.data("roundabout"),n=-1,i={bearing:a.bearing,tilt:a.tilt,stage:{width:Math.floor(.9*$(this).width()),height:Math.floor(.9*$(this).height())},animating:a.animating,inFocus:a.childInFocus,focusBearingRadian:e.degToRad.apply(null,[a.focusBearing]),shape:$.roundaboutShapes[a.shape]||$.roundaboutShapes[$.roundaboutShapes.def]};i.midStage={width:i.stage.width/2,height:i.stage.height/2},i.nudge={width:i.midStage.width+.05*i.stage.width,height:i.midStage.height+.05*i.stage.height},i.zValues={min:a.minZ,max:a.maxZ,diff:a.maxZ-a.minZ},i.opacity={min:a.minOpacity,max:a.maxOpacity,diff:a.maxOpacity-a.minOpacity},i.scale={min:a.minScale,max:a.maxScale,diff:a.maxScale-a.minScale},t.children(a.childSelector).each(function(o){!e.updateChild.apply(t,[$(this),i,o,function(){$(this).trigger("ready")}])||i.animating&&!a.lastAnimationStep?$(this).removeClass("roundabout-in-focus"):(n=o,$(this).addClass("roundabout-in-focus"))}),n!==i.inFocus&&(a.triggerBlurEvents&&t.children(a.childSelector).eq(i.inFocus).trigger("blur"),a.childInFocus=n,a.triggerFocusEvents&&-1!==n&&t.children(a.childSelector).eq(n).trigger("focus")),t.trigger("childrenUpdated")})},updateChild:function(t,a,n,i){var o,r=this,u=$(t),l=u.data("roundabout"),s=[],d=e.degToRad.apply(null,[360-l.degrees+a.bearing]);return i=i||function(){},d=e.normalizeRad.apply(null,[d]),o=a.shape(d,a.focusBearingRadian,a.tilt),o.scale=o.scale>1?1:o.scale,o.adjustedScale=(a.scale.min+a.scale.diff*o.scale).toFixed(4),o.width=(o.adjustedScale*l.startWidth).toFixed(4),o.height=(o.adjustedScale*l.startHeight).toFixed(4),u.css({left:(o.x*a.midStage.width+a.nudge.width-o.width/2).toFixed(0)+"px",top:(o.y*a.midStage.height+a.nudge.height-o.height/2).toFixed(0)+"px",width:o.width+"px",height:o.height+"px",opacity:(a.opacity.min+a.opacity.diff*o.scale).toFixed(2),zIndex:Math.round(a.zValues.min+a.zValues.diff*o.z),fontSize:(o.adjustedScale*l.startFontSize).toFixed(1)+"px"}),l.currentScale=o.adjustedScale,r.data("roundabout").debug&&(s.push('<div style="font-weight: normal; font-size: 10px; padding: 2px; width: '+u.css("width")+'; background-color: #ffc;">'),s.push('<strong style="font-size: 12px; white-space: nowrap;">Child '+n+"</strong><br />"),s.push("<strong>left:</strong> "+u.css("left")+"<br />"),s.push("<strong>top:</strong> "+u.css("top")+"<br />"),s.push("<strong>width:</strong> "+u.css("width")+"<br />"),s.push("<strong>opacity:</strong> "+u.css("opacity")+"<br />"),s.push("<strong>height:</strong> "+u.css("height")+"<br />"),s.push("<strong>z-index:</strong> "+u.css("z-index")+"<br />"),s.push("<strong>font-size:</strong> "+u.css("font-size")+"<br />"),s.push("<strong>scale:</strong> "+u.data("roundabout").currentScale),s.push("</div>"),u.html(s.join(""))),u.trigger("reposition"),i.apply(r),e.isInFocus.apply(r,[l.degrees])},setBearing:function(t,a){return a=a||function(){},t=e.normalize.apply(null,[t]),this.each(function(){var a,n=$(this),i=n.data("roundabout"),o=i.bearing;i.bearing=t,n.trigger("bearingSet"),e.updateChildren.apply(n),a=Math.abs(o-t),!i.animating||a>180||(a=Math.abs(o-t),n.children(i.childSelector).each(function(){var a;e.isChildBackDegreesBetween.apply($(this),[t,o])&&(a=o>t?"Clockwise":"Counterclockwise",$(this).trigger("move"+a+"ThroughBack"))}))}),a.apply(this),this},adjustBearing:function(t,a){return a=a||function(){},0===t?this:(this.each(function(){e.setBearing.apply($(this),[$(this).data("roundabout").bearing+t])}),a.apply(this),this)},setTilt:function(t,a){return a=a||function(){},this.each(function(){$(this).data("roundabout").tilt=t,e.updateChildren.apply($(this))}),a.apply(this),this},adjustTilt:function(t,a){return a=a||function(){},this.each(function(){e.setTilt.apply($(this),[$(this).data("roundabout").tilt+t])}),a.apply(this),this},animateToBearing:function(t,a,n,i,o){var r=(new Date).getTime();return o=o||function(){},$.isFunction(i)?(o=i,i=null):$.isFunction(n)?(o=n,n=null):$.isFunction(a)&&(o=a,a=null),this.each(function(){var u,l,s,d=$(this),p=d.data("roundabout"),c=a?a:p.duration,h=n?n:p.easing||"swing";return i||(i={timerStart:r,start:p.bearing,totalTime:c}),u=r-i.timerStart,p.stopAnimation?(e.allowAnimation.apply(d),p.animating=!1,void 0):(c>u?(p.animating||d.trigger("animationStart"),p.animating=!0,"string"==typeof $.easing.def?(l=$.easing[h]||$.easing[$.easing.def],s=l(null,u,i.start,t-i.start,i.totalTime)):s=$.easing[h](u/i.totalTime,u,i.start,t-i.start,i.totalTime),e.compareVersions.apply(null,[$().jquery,"1.7.2"])>=0&&!$.easing.easeOutBack&&(s=i.start+(t-i.start)*s),s=e.normalize.apply(null,[s]),p.dragBearing=s,e.setBearing.apply(d,[s,function(){setTimeout(function(){e.animateToBearing.apply(d,[t,c,h,i,o])},0)}])):(p.lastAnimationStep=!0,t=e.normalize.apply(null,[t]),e.setBearing.apply(d,[t,function(){d.trigger("animationEnd")}]),p.animating=!1,p.lastAnimationStep=!1,p.dragBearing=t,o.apply(d)),void 0)}),this},animateToNearbyChild:function(t,a){var n=t[0],i=t[1],o=t[2]||function(){};return $.isFunction(i)?(o=i,i=null):$.isFunction(n)&&(o=n,n=null),this.each(function(){var t,r,u=$(this),l=u.data("roundabout"),s=l.reflect?l.bearing:l.bearing%360,d=u.children(l.childSelector).length;if(!l.animating)if(l.reflect&&"previous"===a||!l.reflect&&"next"===a){for(s=Math.abs(s)<l.floatComparisonThreshold?360:s,t=0;d>t;t+=1)if(r={lower:l.period*t,upper:l.period*(t+1)},r.upper=t===d-1?360:r.upper,s<=Math.ceil(r.upper)&&s>=Math.floor(r.lower)){2===d&&360===s?e.animateToDelta.apply(u,[-180,n,i,o]):e.animateBearingToFocus.apply(u,[r.lower,n,i,o]);break}}else for(s=Math.abs(s)<l.floatComparisonThreshold||360-Math.abs(s)<l.floatComparisonThreshold?0:s,t=d-1;t>=0;t-=1)if(r={lower:l.period*t,upper:l.period*(t+1)},r.upper=t===d-1?360:r.upper,s>=Math.floor(r.lower)&&s<Math.ceil(r.upper)){2===d&&360===s?e.animateToDelta.apply(u,[180,n,i,o]):e.animateBearingToFocus.apply(u,[r.upper,n,i,o]);break}})},animateToNearestChild:function(t,a,n){return n=n||function(){},$.isFunction(a)?(n=a,a=null):$.isFunction(t)&&(n=t,t=null),this.each(function(){var i=e.getNearestChild.apply($(this));e.animateToChild.apply($(this),[i,t,a,n])})},animateToChild:function(t,a,n,i){return i=i||function(){},$.isFunction(n)?(i=n,n=null):$.isFunction(a)&&(i=a,a=null),this.each(function(){var o,r=$(this),u=r.data("roundabout");u.childInFocus===t||u.animating||(o=r.children(u.childSelector).eq(t),e.animateBearingToFocus.apply(r,[o.data("roundabout").degrees,a,n,i]))})},animateToNextChild:function(){return e.animateToNearbyChild.apply(this,[arguments,"next"])},animateToPreviousChild:function(){return e.animateToNearbyChild.apply(this,[arguments,"previous"])},animateToDelta:function(t,a,n,i){return i=i||function(){},$.isFunction(n)?(i=n,n=null):$.isFunction(a)&&(i=a,a=null),this.each(function(){var o=$(this).data("roundabout").bearing+t;e.animateToBearing.apply($(this),[o,a,n,i])})},animateBearingToFocus:function(t,a,n,i){return i=i||function(){},$.isFunction(n)?(i=n,n=null):$.isFunction(a)&&(i=a,a=null),this.each(function(){var o=$(this).data("roundabout").bearing-t;o=Math.abs(360-o)<Math.abs(o)?360-o:-o,o=o>180?-(360-o):o,0!==o&&e.animateToDelta.apply($(this),[o,a,n,i])})},stopAnimation:function(){return this.each(function(){$(this).data("roundabout").stopAnimation=!0})},allowAnimation:function(){return this.each(function(){$(this).data("roundabout").stopAnimation=!1})},startAutoplay:function(t){return this.each(function(){var a=$(this),n=a.data("roundabout");t=t||n.autoplayCallback||function(){},clearInterval(n.autoplayInterval),n.autoplayInterval=setInterval(function(){e.animateToNextChild.apply(a,[t])},n.autoplayDuration),n.autoplayIsRunning=!0,a.trigger("autoplayStart")})},stopAutoplay:function(t){return this.each(function(){clearInterval($(this).data("roundabout").autoplayInterval),$(this).data("roundabout").autoplayInterval=null,$(this).data("roundabout").autoplayIsRunning=!1,t||$(this).unbind(".autoplay"),$(this).trigger("autoplayStop")})},toggleAutoplay:function(t){return this.each(function(){var a=$(this),n=a.data("roundabout");t=t||n.autoplayCallback||function(){},e.isAutoplaying.apply($(this))?e.stopAutoplay.apply($(this),[t]):e.startAutoplay.apply($(this),[t])})},isAutoplaying:function(){return this.data("roundabout").autoplayIsRunning},changeAutoplayDuration:function(t){return this.each(function(){var a=$(this),n=a.data("roundabout");n.autoplayDuration=t,e.isAutoplaying.apply(a)&&(e.stopAutoplay.apply(a),setTimeout(function(){e.startAutoplay.apply(a)},10))})},normalize:function(t){var a=t%360;return 0>a?360+a:a},normalizeRad:function(t){for(;0>t;)t+=2*Math.PI;for(;t>2*Math.PI;)t-=2*Math.PI;return t},isChildBackDegreesBetween:function(t,a){var n=$(this).data("roundabout").backDegrees;return t>a?n>=a&&t>n:a>n&&n>=t},getAnimateToMethod:function(t){return t=t.toLowerCase(),"next"===t?"animateToNextChild":"previous"===t?"animateToPreviousChild":"animateToNearestChild"},relayoutChildren:function(){return this.each(function(){var t=$(this),a=$.extend({},t.data("roundabout"));a.startingChild=t.data("roundabout").childInFocus,e.init.apply(t,[a,null,!0])})},getNearestChild:function(){var t=$(this),a=t.data("roundabout"),n=t.children(a.childSelector).length;return a.reflect?Math.round(a.bearing/a.period)%n:(n-Math.round(a.bearing/a.period)%n)%n},degToRad:function(t){return e.normalize.apply(null,[t])*Math.PI/180},getPlacement:function(t){var a=this.data("roundabout");return a.reflect?a.period*t:360-a.period*t},isInFocus:function(t){var a,n=this,i=n.data("roundabout"),o=e.normalize.apply(null,[i.bearing]);return t=e.normalize.apply(null,[t]),a=Math.abs(o-t),a<=i.floatComparisonThreshold||a>=360-i.floatComparisonThreshold},getChildInFocus:function(){var t=$(this).data("roundabout");return t.childInFocus>-1?t.childInFocus:!1},compareVersions:function(t,a){var n,i=t.split(/\./i),e=a.split(/\./i),o=i.length>e.length?i.length:e.length;for(n=0;o>=n;n++){if(i[n]&&!e[n]&&0!==parseInt(i[n],10))return 1;if(e[n]&&!i[n]&&0!==parseInt(e[n],10))return-1;if(i[n]!==e[n]&&i[n]&&e[n])return parseInt(i[n],10)>parseInt(e[n],10)?1:-1}return 0}},$.fn.roundabout=function(t){return e[t]?e[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"==typeof t||$.isFunction(t)||!t?e.init.apply(this,arguments):($.error("Method "+t+" does not exist for jQuery.roundabout."),void 0)},function(t,n,i){var e=t&&t.jquery?t:n;e.is(":visible")?a(t,n,i):e.on("resize",function(){a(t,n,i)})}});