
{#$cssFile = array("pending-detail.css?v={#$cfg_staticVersion#}")#}
{#include file='../_header.html' pageTitle=$langData['siteConfig'][19][313] cssFile=$cssFile goBack=1 rbtn=''#}

<style type="text/css">
.map {position: relative; display:block;margin-top:.5rem;height:2rem;}
#map {position: relative; z-index: 1; width: 100%; height: 2rem;}
.map .market {position: absolute; z-index: 2; left: 50%; top: 50%; width: .6rem; height: .6rem; margin: -.4rem 0 0 -.3rem; background: url('/static/images/local.png'); background-size: cover;}
.refresh {width:100%;height:1rem;line-height:1rem;font-size:0.3rem;background:#e95249;text-align:center;color:#fff;position:fixed;bottom:0;left:0;right:0;}
.refresh:hover {color: #fff;}

.mapPath {position: fixed; left: 0; top: 0; right: 0; bottom: 0; background: #fff; z-index: 100; display: none;}
#mapPath {position: absolute; left: 0; top: 0; right: 0; bottom: 0; z-index: 1;}


.bubble {-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-transition: background-color .15s ease-in-out; -moz-transition: background-color .15s ease-in-out; -o-transition: background-color .15s ease-in-out; transition: background-color .15s ease-in-out; cursor: pointer; opacity: 0.9; width: 40px; height: 40px; background-size: cover;}
/*.bubble-3 {height: 28px; line-height: 28px; cursor: pointer; text-align: center; margin: 0;}*/
.bubble-3 .num {padding: 0 6px; display: inline-block; background-color: #de1e30; border-radius: 2px; border: 1px solid #de1e30; min-width: 40px; -webkit-transition: all .15s ease-in-out; -moz-transition: all .15s ease-in-out; -o-transition: all .15s ease-in-out; transition: all .15s ease-in-out; font-style: normal; color: #fff;}
.bubble-3 .name {height: 30px; color: #333; position: absolute; z-index: -1; line-height: 30px; -webkit-transition: all .15s ease-in-out; -moz-transition: all .15s ease-in-out; -o-transition:all .15s ease-in-out; transition: all .15s ease-in-out; opacity: 0; visibility: hidden;}
.bubble-3 .name-des {background-color: #fff; display: inline-block; padding: 0 6px; border-radius: 0 3px 3px 0; box-shadow: 0 2px 2px rgba(0,0,0,0.2); font-style: normal;}
.bubble-3 .name-des a {color: #333}
.bubble-3 .name-des a:hover {text-decoration: underline;}


.bubble-3.shop .num {background-color: #4285f4; border-color: #4285f4; color: #fff;}
.bubble-3.shop .name {visibility: visible; opacity: 1;}
.bubble-3.shop .arrow-up {border-top-color: #4285f4;}
.bubble-3.shop .arrow {border-top-color: #4285f4;}
.label-clicked {z-index:3!important;}
.arrow-up {opacity: .9999; zoom: 1;}


.bubble-3.person .num {background-color: green; border-color: green; color: #fff;}
.bubble-3.person .name {visibility: visible; opacity: 1;}
.bubble-3.person .arrow-up {border-top-color: green;}
.bubble-3.person .arrow {border-top-color: green;}


.arrow-up,.arrow {border: 6px solid transparent; border-top-color: #de1e30; border-top-width: 8px; display: block; width: 0; height: 0; margin: 0 auto; -webkit-transition: all .15s ease-in-out; -moz-transition: all .15s ease-in-out; -o-transition: all .15s ease-in-out; transition: all .15s ease-in-out;}
.arrow {border-top-color: #de1e30; margin-left: -6px; margin-top: -9px; position: relative;}
label.BMapLabel {max-width: inherit;}

.bubble.shop {background-image: url('/static/images/shop_local.png?v=1');}
.bubble.courier {background-image: url('/static/images/courier_local.png?v=1');}
.bubble.person {background-image: url('/static/images/person_local.png?v=1'); width: 30px; height: 30px;}

.mapBtn {position: absolute; z-index: 2; left: 0; top: 0; right: 0;}
.mapBtn button {position: absolute; top: .3rem; width: .8rem; height: .8rem; background-color: #fff; background-position: center; background-repeat: no-repeat; box-shadow: 0 0 5px rgba(0, 0, 0, .2); border: 0; border-radius: 3px; outline: 0;}
#closeMap {left: .3rem; background-image: url('/static/images/close.png'); background-size: .4rem;}
#refreshMap {right: .3rem; background-image: url('/static/images/refresh.png'); background-size: .4rem;}

</style>
  <div class="container">

    <div class="bgfff">
      <p class="title"><span class="icon-1">{#$langData['siteConfig'][16][76]#}</span></p>
      <ul class="goods">
        <li>
          <span class="span-1">{#$langData['siteConfig'][17][12]#}</span>
          <span class="span-2">{#$shopname#}</span>
        </li>
        <li class="food">
          <div>{#$langData['waimai'][1][210]#}</div>
          <div class="detail">
          {#foreach from=$food item=f#}
          <font class="name">{#$f.title#}{#$f.ntitle#}</font><font class="count">×{#$f.count#}</font><font class="price">&yen;{#$f.price * $f.count#}</font><br />
          {#/foreach#}
          </div>
        </li>
        <li>
          <span class="span-1">{#$langData['waimai'][1][211]#}</span>
          <span class="span-2" style="color:#f05050;">{#$note#}</span>
        </li>
        <li>
          <span class="span-1">{#$langData['waimai'][5][3]#}</span>
          <span class="span-2">
            {#foreach from=$preset item=p#}
            {#$p.title#}：{#$p.value#}<br />
            {#/foreach#}
          </span>
        </li>
        <li>
          <span class="span-1">{#$langData['waimai'][5][4]#}</span>
          <span class="span-2">
            {#foreach from=$priceinfo item=p#}
            {#$p.body#}：{#if $p.type == "youhui" || $p.type == "manjian" || $p.type == "shoudan"#}-{#/if#}{#$p.amount#}<br />
            {#/foreach#}
          </span>
        </li>
        <li>
          <span class="span-1">{#$langData['siteConfig'][19][312]#}</span>
          <span class="span-2">{#$amount#}</span>
        </li>
        <li>
          <span class="span-1">{#$langData['siteConfig'][19][52]#}</span>
          <span class="span-2">{#$paytype#}</span>
        </li>
      </ul>
    </div>

    <div class="bgfff">
      <p class="title"><span class="icon-2">{#$langData['siteConfig'][16][65]#}</span></p>
      <ul class="buyer">
        <li><span class="span-1">{#$langData['siteConfig'][19][4]#}：</span><span class="span-2">{#$username#}<i class="vip" style="display:none;"></i></span></li>
        <li><span class="span-1">{#$langData['siteConfig'][19][56]#}：</span><span class="span-2"><a href="tel:{#$tel#}" class="tel">{#$tel#}</a></span></li>
        <li><span class="span-1">{#$langData['waimai'][1][209]#}：</span><span class="span-2">{#$address#}</span></li>
      </ul>
    </div>

    <div class="bgfff">
      <p class="title"><span class="icon-3">{#$langData['siteConfig'][19][319]#}</span></p>
      <ul class="buyer">
        <li><span class="span-1">{#$langData['siteConfig'][19][308]#}：</span><span class="span-2">{#$shopname|cat:$ordernumstore#}</span></li>
        <li><span class="span-1">{#$langData['siteConfig'][19][309]#}：</span><span class="span-2">{#if $pubdate#}{#$pubdate|date_format:"%Y-%m-%d %H:%M:%S"#}{#/if#}</span></li>

        <li><span class="span-1">{#$langData['siteConfig'][19][53]#}：</span><span class="span-2">{#if $paydate > 0#}{#$paydate|date_format:"%Y-%m-%d %H:%M:%S"#}{#/if#}</span></li>

        <li><span class="span-1">{#$langData['siteConfig'][19][52]#}：</span><span class="span-2{#if $paytype == $langData['siteConfig'][16][51]#} red{#/if#}">{#$paytype#}</span></li>

        <li><span class="span-1">{#$langData['waimai'][4][8]#}：</span><span class="span-2">{#if $confirmdate#}{#$confirmdate|date_format:"%Y-%m-%d %H:%M:%S"#}{#/if#}</span></li>

        <li><span class="span-1">{#$langData['siteConfig'][17][26]#}：</span><span class="span-2">{#if $peidate#}{#$peidate|date_format:"%Y-%m-%d %H:%M:%S"#}{#/if#}</span></li>

        <li><span class="span-1">{#$langData['siteConfig'][17][27]#}：</span><span class="span-2">{#if $songdate#}{#$songdate|date_format:"%Y-%m-%d %H:%M:%S"#}{#/if#}</span></li>
        <li><span class="span-1">{#$langData['waimai'][1][226]#}：</span><span class="span-2">{#if $okdate#}{#$okdate|date_format:"%Y-%m-%d %H:%M:%S"#}{#/if#}</span></li>

        <li><span class="span-1">{#$langData['waimai'][1][227]#}：</span><span class="span-2">{#if $okdate#}{#ceil(($okdate-$pubdate)/60)#}{#/if#}</span></li>

        <li>
          <span class="span-1">{#$langData['siteConfig'][16][50]#}：</span>
          <span class="span-2">
            {#if $state == 0#}
            {#$langData['siteConfig'][9][22]#}
            {#elseif $state == 1#}
            {#$langData['siteConfig'][6][3]#}<br>{#$langData['waimai'][1][221]#} {#if $merchant_deliver#}{#$langData['waimai'][5][5]#}{#else#}{#$peisong#}：<a href="tel:{#$peisongphone#}">{#$peisongphone#}</a>{#/if#}
            {#elseif $state == 2#}
            {#$langData['siteConfig'][9][11]#}
            {#elseif $state == 3#}
              {#if $merchant_deliver#}{#$langData['waimai'][5][5]#}{#else#}{#$langData['siteConfig'][9][46]#}{#/if#}
            {#elseif $state == 4#}
            {#$langData['siteConfig'][16][114]#}<br>{#$langData['waimai'][1][221]#} {#$peisong#}：<a href="tel:{#$peisongphone#}" style="color:#2164fb;">{#$peisongphone#}</a>
            {#elseif $state == 5#}
            {#$langData['siteConfig'][16][115]#}<br>{#$langData['waimai'][1][221]#} {#$peisong#}：<a href="tel:{#$peisongphone#}" style="color:#2164fb;">{#$peisongphone#}</a>
            {#elseif $state == 6#}
            {#$langData['siteConfig'][6][112]#}
            {#elseif $state == 7#}
            {#$langData['siteConfig'][9][47]#}
            {#/if#}
          </span>
        </li>
        {#if $state == 4#}
        <div class="map">
          <div id="map"></div>
          <div class="market"></div>
        </div>

        <div class="mapPath">
          <div id="mapPath"></div>
          <div class="mapBtn">
            <button id="closeMap"></button>
            <button id="refreshMap"></button>
          </div>
        </div>
        {#/if#}

        {#if $state == 6 || $state == 7#}
        <li>
          <span class="span-1">{#$langData['siteConfig'][16][66]#}：</span>
          <span class="span-2">{#$failed#}</span>
        </li>
        {#/if#}

      </ul>
    </div>

  </div>


  {#if $state == 2 || $state == 3 || $state == 4#}
  <!-- 底部 s -->
  <div class="footer merchant_deliver_{#$merchant_deliver#}">
    <ul class="fn-clear">
      <li><a href="javascript:;" class="fail">{#$langData['waimai'][5][6]#}</a></li>
      {#if $merchant_deliver && $state != 2#}
      <!-- 商家自配并且订单已确认 -->
      <li><a href="javascript:;" class="complete" id="okObj">{#$langData['siteConfig'][6][108]#}</a></li>
      {#/if#}
      {#if $state == 2#}<li><a href="javascript:;" class="success">{#$langData['waimai'][5][7]#}</a></li>{#/if#}
    </ul>
  </div>
  <!-- 底部 e -->
  {#/if#}

  <div class="failbox">
    <div class="mask"></div>
    <form class="whyform" method="post">
      <p>{#$langData['waimai'][5][8]#}</p>
      <textarea name="fail" class="textarea"></textarea>
      <p class="btn"><a href="javascript:;" class="sure" id="failedObj">{#$langData['siteConfig'][6][1]#}</a><a href="javascript:;" class="cancel">{#$langData['siteConfig'][6][12]#}</a></p>
    </form>
  </div>

<script>var id = {#$id#};</script>

{#if $peisongid && $state == 4#}
<script type="text/javascript" src="http://api.map.baidu.com/getscript?v=2.0&ak={#$site_map_key#}&services=&t={#$smarty.now#}"></script>
<script type="text/javascript">

  var mapPath, peisongpath = '';
  var map = new BMap.Map("map");

  //小地图
  getCourierLocal(function(data){
    peisongpath = data;
    var pos = data.split(",");
    var mPoint = new BMap.Point(pos[0], pos[1]);
    var marker = new BMap.Marker(mPoint);
    map.disableDragging();
    setTimeout(function(){
      map.centerAndZoom(mPoint, 16);
      // map.addOverlay(marker);
    }, 500);
  })


  //关闭大地图
  $("#closeMap").bind("click", function(){
    $(".mapPath").hide();
    getCourierLocal();
  });

  //气泡样式
  var labelStyle = {
    color: "#fff",
    borderWidth: "0",
    padding: "0",
    zIndex: "2",
    backgroundColor: "transparent",
    textAlign: "center",
    fontFamily: '"Hiragino Sans GB", "Microsoft Yahei UI", "Microsoft Yahei", "微软雅黑", "Segoe UI", Tahoma, "宋体b8bf53", SimSun, sans-serif'
  }

  //点击小地图查看大地图
  $("#map").bind("click", function(){

    $(".mapPath").show();

    //派送员路径
    var pointArr = [];
    mapPath = new BMap.Map("mapPath");

    //店铺坐标
    var pointShop = new BMap.Point({#$coordY#}, {#$coordX#});
    var bubbleLabelShop = new BMap.Label('<p class="bubble-3 bubble shop"></p>', {
      position: pointShop,
      offset: new BMap.Size(-20, -45)
    });
    bubbleLabelShop.setStyle(labelStyle);
    mapPath.addOverlay(bubbleLabelShop);
    pointArr.push(pointShop);

    //终点坐标
    var pointPerson = new BMap.Point({#$coordY#}, {#$coordX#});
    var bubbleLabelPerson = new BMap.Label('<p class="bubble-3 bubble person"></p>', {
      position: pointPerson,
      offset: new BMap.Size(-15, -15)
    });
    bubbleLabelPerson.setStyle(labelStyle);
    mapPath.addOverlay(bubbleLabelPerson);
    pointArr.push(pointPerson);

    //更新骑手位置 & 画线
    updateCourierLocation(peisongpath);

    //设置中心点
    var pos = peisongpath.split(',');
    pointArr.push(new BMap.Point(pos[0], pos[1]));
    mapPath.setViewport(pointArr);
    mapPath.setZoom(mapPath.getZoom() - 1);

  });


  //刷新骑手位置
  $("#refreshMap").bind("click", function(){
    getCourierLocal(function(data){
      updateCourierLocation(data);
    })
  });

  // 获取骑手位置
  function getCourierLocal(callback){
    $.ajax({
      url: "/include/ajax.php",
      type: "post",
      data: {service: "waimai", action: "getCourierLocal", id: {#$peisongid#}},
      dataType: "json",
      success: function(res){
        if(res.state == 100){
          if(typeof callback == 'function'){
            callback(res.info);
          }
        }
      }
    })
  }

  //更新骑手位置 & 画线
  var bubbleLabelCourier, polylineCourier;
  function updateCourierLocation(pathData){

    if(!pathData || pathData == "") return false;

    if(bubbleLabelCourier){
        map.removeOverlay(bubbleLabelCourier);
    }

    //获取骑手最新位置
    var psData = pathData.split(";");
    psData = psData[psData.length-1].split(",");

    //骑手坐标
    var pointCourier = new BMap.Point(psData[0], psData[1]);
    bubbleLabelCourier = new BMap.Label('<p class="bubble-3 bubble courier"></p>', {
      position: pointCourier,
      offset: new BMap.Size(-20, -45)
    });
    bubbleLabelCourier.setStyle(labelStyle);
    mapPath.addOverlay(bubbleLabelCourier);

    //画折线
    /*if(pathData){

      if(polylineCourier){
              map.removeOverlay(polylineCourier);
          }

      var pathsArr = [];
      pathArr = pathData.split(";");
      for(var i = 0; i < pathArr.length; i++){
        var p = pathArr[i].split(",");
        pathsArr.push(new BMap.Point(p[0],p[1]));
      }
      polylineCourier = new BMap.Polyline(pathsArr, {strokeColor:"blue", strokeWeight:2, strokeOpacity:.9, strokeStyle:'dashed'});
      mapPath.addOverlay(polylineCourier);
    }*/
  }

</script>

{#/if#}

{#$jsFile = array("waimaiOrderDetail.js?v={#$cfg_staticVersion#}")#}
{#include file='../_footer.html' curr='order' nobtm=1#}
</body>
</html>
